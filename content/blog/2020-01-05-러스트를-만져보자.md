---
title: 러스트를 만져보자
date: 2020-01-04T17:24:38.852Z
description: '!!'
---
뭐 걍.. 저수준 언어를 해보고 싶기도 하고 wasm 도 좀 만져보고 싶어서 이것저것 건드려보는 중이다. 일단 최근에 만든 bpm tapper의 코어 부분을 rust 로 옮겨보았다.

원래 타입스크립트 코드는 이랬다. bpm 관련 동작을 담당하는 간단한 `Tapper` 클래스를 만들었고, `tap()` 메소드, `reset()` 메소드, 계산된 bpm을 얻는 `bpm()` getter로 이루어져있다.

```ts
export class Tapper {
  private static instance: Tapper
  private cue: number[] = []

  public static new() {
    if (!Tapper.instance) {
      Tapper.instance = new Tapper()
    }
    return Tapper.instance
  }

  tap() {
    let cur = Date.now()
    let last = this.cue[this.cue.length - 1]
    if (cur - last > 2000) {
      this.reset()
    }
    this.cue.push(cur)
  }

  reset() {
    this.cue = []
  }

  get bpm() {
    if (this.cue.length < 2) return 0

    let beatCount = this.cue.length - 1
    let duration = this.cue[0] - this.cue[this.cue.length - 1]
    let averageBpm = 60000 * beatCount / duration

    return Math.round(averageBpm * 10) / 10
  }
}
```

그럼 한 부분씩 rust로 옮겨보자.

```rust
use chrono::Utc;

struct Tapper {
    cue: Vec<i64>,
}

impl Tapper {
    fn new() -> Tapper {
        Tapper { cue: vec![] }
    }

    fn tap(&mut self) {
        let ms = Utc::now().timestamp();
        self.cue.push(ms);
    }

    fn reset(&mut self) {
        self.cue = vec![]
    }

    fn get_bpm(&self) -> i64 {
        let cue = &self.cue;
        let beats = cue.len() - 1;
        let duration = cue[0] - cue[cue.len() - 1];
        let average_bpm = 60000 * beats as i64 / duration;

        return average_bpm;
    }
}
```
